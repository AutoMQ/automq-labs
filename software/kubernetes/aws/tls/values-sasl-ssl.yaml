#
# values-sasl-ssl.yaml
# This file is for deploying AutoMQ with SASL_SSL authentication.
# Clients will authenticate using username/password over a TLS-encrypted channel.
#
global:
  automqInstanceId: "<your-unique-instance-id>"
  image:
    tag: "5.3.1-snapshot-1763923342"
    pullPolicy: Always
  cloudProvider:
    name: aws
    credentials: pod://?
  serviceAccount:
    create: true
    annotations:
      eks.amazonaws.com/role-arn: "<your-eks-role-arn>"
  config: |
    # --- S3 and WAL Configuration ---
    s3.ops.buckets=1@s3://<your-ops-bucket>?region=<aws-region>
    s3.data.buckets=0@s3://<your-data-bucket>?region=<aws-region>
    s3.wal.path=0@block:///dev/wal?iobandwidth=131072000&iodepth=8&iops=3000&capacity=2147483648
    
    # --- DNS Settings for Hostname Verification ---
    automq.dns.client_sasl_ssl.zone.id=<your-route53-zone-id>

# Define a listener for SASL_SSL clients.
listeners:
  client:
    - containerPort: 9112
      protocol: SASL_SSL
      name: CLIENT_SASL_SSL

# Configure server-side TLS by referencing the Kubernetes secret containing the server certificate.
tls:
  type: PEM
  existingSecret: automq-server-tls

# Expose the SASL_SSL port (9112) via a Network Load Balancer.
externalAccess:
  controller:
    enabled: true
    service:
      type: LoadBalancer
      loadBalancerAnnotations:
        service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip
        service.beta.kubernetes.io/aws-load-balancer-subnets: "<your_multi_az_subnet_ids>"
        service.beta.kubernetes.io/aws-load-balancer-type: external
      extraPorts:
        - name: "sasl-client"
          port: 9112
          protocol: "TCP"
          targetPort: 9112

# Enable ACLs and define the SASL user '_automq' as the superuser.
acl:
  enabled: true
  superUsers:
    - "_automq"

# Define credentials for the superuser '_automq' and a regular user 'my-user'.
sasl:
  controller:
    password: "<your-sasl-password>"
    user: _automq
  interbroker:
    password: "<your-sasl-password>"
    user: _automq
  client:
    users:
      - "my-user"
    passwords:
      - "<your-sasl-password>"

# --- Resource and Persistence Settings ---
controller:
  replicas: 3
  resources:
    requests:
      cpu: "1000m"
      memory: "12Gi"
  persistence:
    metadata:
      storageClass: "gp3"
      size: "20Gi"
    wal:
      storageClass: "gp3"
      size: "20Gi"
  env:
    - name: "KAFKA_HEAP_OPTS"
      value: "-Xmx6g -Xms6g -XX:MaxDirectMemorySize=6g"

broker:
  replicas: 0
  resources:
    requests:
      cpu: "1000m"
      memory: "12Gi"
  persistence:
    wal:
      storageClass: "gp3"
      size: "20Gi"
  env:
    - name: "KAFKA_HEAP_OPTS"
      value: "-Xmx6g -Xms6g -XX:MaxDirectMemorySize=6g"
