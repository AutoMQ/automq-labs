services:
  producer:
    build:
      context: ./producer
    container_name: github-event-producer
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=automq:9092
      - SCHEMA_REGISTRY_URL=http://schema-registry:8081
      - TOPIC_NAME=github_events_iceberg
      # 示例：下载并发送 2025-01-01 15:00 的数据
      - EVENT_DATE=2025-01-01
      - EVENT_HOUR=15
    networks:
      - playground_default

  debug:
    image: curlimages/curl
    container_name: github-event-debug
    command: ["sleep", "infinity"]
    networks:
      - playground_default

  marimo:
    image: tabulario/spark-iceberg
    container_name: github-event-marimo
    working_dir: /home/iceberg
    volumes:
      - ./notebooks:/home/iceberg/notebooks
    ports:
      - "2718:2718"
    environment:
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=password
      - AWS_REGION=us-east-1
      - SPARK_DRIVER_MEMORY=2g
      - SPARK_EXECUTOR_MEMORY=2g
      - SPARK_LOCAL_IP=127.0.0.1
      - JAVA_OPTS=-Xmx2g
    entrypoint: [""]
    command: >
      bash -c "
      pip install marimo pandas schedule &&
      cd /home/iceberg/notebooks &&
      marimo run analysis.py --host 0.0.0.0 --port 2718
      "
    networks:
      - playground_default

networks:
  playground_default:
    external: true
    name: playground_default

